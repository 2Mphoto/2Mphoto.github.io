<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lieux</title>
  <!-- Même CSS que Instant -->
  <style>
    :root{--bg:#070a12;--glass:rgba(255,255,255,.10);--glass2:rgba(255,255,255,.16);--line:rgba(255,255,255,.22);--txt:rgba(255,255,255,.92);--muted:rgba(255,255,255,.72);--shadow:0 20px 70px rgba(0,0,0,.55);--r:18px}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow:hidden}
    .stage{position:relative;width:100vw;height:100vh;display:grid;place-items:center}
    .viewer{position:relative;width:min(1100px,92vw);aspect-ratio:16/10;border-radius:calc(var(--r) + 6px);overflow:hidden;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    .img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transform:scale(1.06);transition:opacity .6s ease,transform 1.8s ease;will-change:opacity,transform}
    .img.is-active{opacity:1;transform:scale(1.00)}
    .viewer::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.20) 55%,rgba(0,0,0,.55));pointer-events:none}
    .topbar{position:absolute;top:18px;left:18px;right:18px;display:flex;align-items:center;justify-content:space-between;gap:10px;z-index:5}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;background:var(--glass);border:1px solid var(--line);backdrop-filter:blur(8px)}
    .chip b{font-weight:650}.chip span{color:var(--muted);font-size:14px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--glass);color:var(--txt);padding:10px 12px;border-radius:999px;cursor:pointer;text-decoration:none;backdrop-filter:blur(8px);transition:transform .18s ease,background .18s ease;user-select:none;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:scale(1.05);background:var(--glass2)}
    .nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 14px;z-index:5;pointer-events:none}
    .nav button{pointer-events:auto;width:44px;height:44px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.28);color:var(--txt);cursor:pointer;display:grid;place-items:center;transition:transform .18s ease,background .18s ease;backdrop-filter:blur(8px)}
    .nav button:hover{transform:scale(1.08);background:rgba(0,0,0,.40)}
    .thumbs{position:absolute;left:18px;right:18px;bottom:18px;z-index:6;display:flex;gap:10px;overflow:auto;padding:10px;border-radius:var(--r);background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(10px);scrollbar-width:thin}
    .thumbs::-webkit-scrollbar{height:10px}.thumbs::-webkit-scrollbar-thumb{background:rgba(255,255,255,.22);border-radius:999px}
    .thumb{flex:0 0 auto;width:92px;height:58px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.16);cursor:pointer;opacity:.75;transition:transform .16s ease,opacity .16s ease,border-color .16s ease;background:rgba(255,255,255,.06)}
    .thumb:hover{transform:scale(1.05);opacity:.95}
    .thumb.is-active{opacity:1;border-color:rgba(255,255,255,.45)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .hint{position:absolute;bottom:94px;left:18px;z-index:7;color:rgba(255,255,255,.72);font-size:13px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.14);padding:8px 10px;border-radius:999px;backdrop-filter:blur(10px)}
    @media (prefers-reduced-motion: reduce){.img{transition:opacity .2s linear;transform:none}.btn,.nav button,.thumb{transition:none}}
  </style>
</head>

<body>
  <main class="stage">
    <section class="viewer" aria-label="Galerie Lieux">
      <div class="topbar">
        <div class="chip">
          <b id="title">Lieux</b>
          <span id="counter">0 / 0</span>
        </div>
        <a class="btn" href="../index.html" title="Retour accueil">⟵ Accueil</a>
      </div>

      <div class="nav">
        <button id="prev" type="button" aria-label="Photo précédente">‹</button>
        <button id="next" type="button" aria-label="Photo suivante">›</button>
      </div>

      <img id="imgA" class="img is-active" alt="" />
      <img id="imgB" class="img" alt="" />

      <div class="hint">Clavier: ← → • Mobile: swipe</div>
      <div id="thumbs" class="thumbs" aria-label="Miniatures"></div>
    </section>
  </main>

  <script>
    const MANIFEST_URL = "../assets/img/lieux/manifest.json";
    const BASE_PATH = "../assets/img/lieux/";

    const titleEl = document.getElementById("title");
    const counterEl = document.getElementById("counter");
    const thumbsEl = document.getElementById("thumbs");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");

    const imgA = document.getElementById("imgA");
    const imgB = document.getElementById("imgB");
    let front = imgA, back = imgB;

    let images = [];
    let idx = 0;
    let isBusy = false;

    function setCounter(){ counterEl.textContent = `${idx + 1} / ${images.length}`; }
    function setActiveThumb(){
      [...thumbsEl.children].forEach((t,i)=>t.classList.toggle("is-active", i===idx));
      const active = thumbsEl.children[idx];
      if (active) active.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
    }
    async function preload(src){
      return new Promise((res, rej)=>{ const im=new Image(); im.onload=res; im.onerror=()=>rej(new Error("Image non trouvée: "+src)); im.src=src; });
    }
    async function show(i){
      if (!images.length) return;
      const target = (i + images.length) % images.length;
      if (isBusy) return;
      isBusy = true;

      const src = BASE_PATH + images[target];
      try{ await preload(src); } catch(e){ console.warn(e); isBusy=false; return; }

      back.src = src;
      back.alt = `${titleEl.textContent} — ${target + 1}`;
      back.classList.add("is-active");
      front.classList.remove("is-active");

      setTimeout(()=>{
        const tmp=front; front=back; back=tmp;
        idx=target; setCounter(); setActiveThumb();
        isBusy=false;
      }, 650);
    }
    function buildThumbs(){
      thumbsEl.innerHTML="";
      images.forEach((name,i)=>{
        const t=document.createElement("button");
        t.type="button"; t.className="thumb";
        const im=document.createElement("img");
        im.loading="lazy"; im.src=BASE_PATH+name; im.alt=`Miniature ${i+1}`;
        t.appendChild(im);
        t.addEventListener("click",()=>show(i));
        thumbsEl.appendChild(t);
      });
    }
    function next(){ show(idx+1); }
    function prev(){ show(idx-1); }
    window.addEventListener("keydown",(e)=>{ if(e.key==="ArrowRight") next(); if(e.key==="ArrowLeft") prev(); });

    let sx=null, sy=null;
    const viewer=document.querySelector(".viewer");
    viewer.addEventListener("touchstart",(e)=>{ if(!e.touches?.length) return; sx=e.touches[0].clientX; sy=e.touches[0].clientY; }, {passive:true});
    viewer.addEventListener("touchend",(e)=>{
      if(sx===null) return;
      const ex=e.changedTouches[0].clientX, ey=e.changedTouches[0].clientY;
      const dx=ex-sx, dy=ey-sy; sx=null; sy=null;
      if(Math.abs(dx)<35 || Math.abs(dx)<Math.abs(dy)) return;
      if(dx<0) next(); else prev();
    }, {passive:true});

    prevBtn.addEventListener("click", prev);
    nextBtn.addEventListener("click", next);

    (async ()=>{
      const res = await fetch(MANIFEST_URL, {cache:"no-store"});
      const data = await res.json();
      titleEl.textContent = data.title || "Lieux";
      images = Array.isArray(data.images) ? data.images : [];
      if(!images.length){ counterEl.textContent="0 / 0"; front.alt="Aucune image"; return; }
      buildThumbs();
      front.src = BASE_PATH + images[0];
      front.alt = `${titleEl.textContent} — 1`;
      idx=0; setCounter(); setActiveThumb();
    })();
  </script>
</body>
</html>
